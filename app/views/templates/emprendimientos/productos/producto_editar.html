{% extends 'layout.html' %}

{% block css %}
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
    <style>
    .round-button{
        width: 10%;
    }
    .my-custom-scrollbar {
        position: relative;
        height: 400px;
        overflow: auto;
    }
        .table-wrapper-scroll-y {
        display: block;
    }
    </style>
{% endblock %}

{% block content %}

<!--Navbar -->
<nav class="mb-1 navbar navbar-expand-lg navbar-dark secondary-color">
    <p class="navbar-brand" style="cursor: default;" href="{{ url_for('views.emprendimientos_views.emprendimiento_home', id=emprendimiento.id_) }}">{{emprendimiento.nombre}}</p>
    <div class="collapse navbar-collapse" id="navbarSupportedContent-333">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{{ url_for('views.productos_views.productos') }}">Productos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.insumos_views.insumos') }}">Insumos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.proveedores_views.proveedores') }}">Proveedores y Pedidos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.costos_views.costos') }}">Costos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.ventas_views.crear_ventas') }}">Ventas</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.clientes_views.clientes') }}">Clientes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('views.informes_views.informes') }}">Informes y Estadísticas</a>
        </li>
      </ul>
      <ul class="navbar-nav ml-auto nav-flex-icons">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink-333" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Mi cuenta <i class="fas fa-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right dropdown-default" aria-labelledby="navbarDropdownMenuLink-333">
            <a class="dropdown-item" href="{{ url_for('views.usuarios_views.editar') }}">Mi usuario</a>
            <a class="dropdown-item" href="{{ url_for('views.emprendimientos_views.emprendimientos') }}">Mis emprendimientos</a>
            <a class="dropdown-item" href="{{ url_for('views.usuarios_views.login') }}">Cerrar sesión</a>
          </div>
        </li>
      </ul>
    </div>
  </nav>

<div class="container">
    <form class="main-form w-100 d-flex justify-content-center align-items-center flex-column" method="POST" action="{{ url_for('api.productos_api.producto_dispatcher') }}" enctype="multipart/form-data">
        
        <input  type="hidden" name="_method"  value="{{method}}"/>
        <input  type="hidden" name="id_"  value="{{producto.id_}}"/>
        
        <div class="row w-100">

            <!-- CAMPOS -->
            <div class="col-4">

                <div class="md-form">
                    <label class="form-label">Nombre</label>
                    <input class="form-control" type="text" name="nombre" value="{{producto.nombre or ''}}" required />
                </div>

                <div class="form-row">
                    <select class="form-control" name="id_proveedor" id="id_proveedor">
                        <option selected disabled>Elegir proveedor</option>
                        {% for proveedor in proveedores %}
                        <option value="{{proveedor.id_}}" {% if proveedor.id_ == producto.id_proveedor %} selected="selected" {% endif %}>{{proveedor.nombre or 'No aplica'}}</option>
                        {% endfor %}
                    </select>
                    <hr>
                </div>

                <div class="md-form">
                    <label class="form-label">Stock mínimo</label>
                    <input class="form-control" type="number" name="stock_minimo" min=0 value={{producto.stock_minimo}} required/>
                </div>
                
                <div class="md-form">
                    <label class="form-label" id="stock_actual_label">Stock actual</label>
                    <input class="form-control" type="number" name="stock_actual" id="stock_actual" min=0 required/>
                </div>

                <div class="md-form">
                    <label class="form-label" id="costo_label">Costo de compra</label>
                    <input class="form-control" type="number" name="costo" id="costo" value="{{producto.costo}}" required/>
                </div>
                <div class="md-form">
                    <label class="form-label" id="precio_label">Precio de venta</label>
                    <input class="form-control" type="number" name="precio" id="precio" value="{{precio_producto.precio}}" required />
                </div>

            </div>

            <!-- INSUMOS -->
            <div class="col-8 d-flex justify-content-center align-items-center flex-column">

                <div class="row h-25 d-flex align-items-center flex-column" style="width: 60%">
                    <div class="round-button">
                        <div class="round-button-circle">
                        <a class="round-button" id="add_insumo"><i class="fas fa-plus"></i></a>
                        </div>
                    </div>
                    <p>Agregar insumo</p>
                </div>

                <div id="agregar-insumo-storage">
                    <select>
                        {% for insumo in insumos %}
                        <option id="{{insumo.id_}}" value="{{insumo.id_}}">{{insumo.nombre}} - ({{ insumo.unidad }})</option>
                        {% endfor %}
                    </select>
                </div>

                {% if insumos %}
                <div class="table-wrapper-scroll-y my-custom-scrollbar" id="agregar-insumo-form">
                    
                    {% for i,linea_insumo in lineas_insumos_range %}
                    <div class="row" id="agregar-insumo-field{{i}}">
                        <div class="md-form col-4">
                            <select class="browser-default custom-select" name="id_insumo{{i}}" onchange="calculate_fields({{i}})" required>
                                {% for insumo in insumos %}
                                <option id="{{insumo.id_}}" value="{{insumo.id_}}" {% if insumo.id_ == linea_insumo.id_insumo %} selected="selected" {% endif %}>{{insumo.nombre}} - ({{ insumo.unidad }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="md-form col-4">
                            <label class="form-label">Cantidad</label>
                            <input class="form-input" type="number" name="cantidad{{i}}" value="{{linea_insumo.cantidad}}" min=0 step=0.01 onchange="calculate_fields({{i}})" required />
                        </div>
                        <div class="md-form col-2">
                            <input class="btn btn-danger btn-sm remove-linea" style="width: 10%;" value="X" />
                        </div>
                    </div>
                    
                    {% endfor %}
                </div>
                {% endif %}
            
            </div>

        
        <div class="row">
            <div class="md-form">
                <button class="form-submit btn btn-primary .btn-sm" id="finalizar" type="submit">Editar producto</button>
            </div>
        </div>
    </form>

</div>

<div class="modal fade" id="modal-productos-form" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body" id="flashes">
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <ul>
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
            </ul>
            {% endif %}
            {% endwith %}
        </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}
    <script src="{{ url_for('static', filename='js/producto_form.js') }}"></script>
{% endblock %}
